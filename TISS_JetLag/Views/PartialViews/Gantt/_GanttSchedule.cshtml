@model List<TISS_JetLag.ViewModels.GanttSegmentViewModel>
<link href="~/css/GanttStyle/gantt-schedule.css" rel="stylesheet" />
@{
    var segments = Model.OrderBy(s => s.Start).ToList();
    var groupedByDay = segments
        .GroupBy(s => new { Date = s.Start.Date, Location = s.LocationLabel })
        .OrderBy(g => g.Key.Date)
        .ToList();

    Func<DateTime, DateTime, double> GetHourOffset = (start, point) => (point - start).TotalHours;
    Func<DateTime, DateTime, string> ToPx = (start, end) => $"{(end - start).TotalHours * 40}px"; // 1小時=40px
}

<div class="gantt-container">
    @foreach (var group in groupedByDay)
    {
        var minTime = group.Min(s => s.Start);
        var categories = group.Select(s => s.Category).Distinct().OrderBy(c => c);

        <div class="gantt-day-block">
            <div class="gantt-label">@group.Key.Date.ToString("M/d") @group.Key.Location</div>

            @foreach (var category in categories)
            {
                var rowSegments = group.Where(s => s.Category == category).OrderBy(s => s.Start).ToList();
                <div class="gantt-row">
                    @foreach (var segment in rowSegments)
                    {
                        var bg = segment.Color;
                        if (segment.Category.Contains("起飛")) bg = "#E67E22";
                        else if (segment.Category.Contains("降落")) bg = "#8E44AD";
                        else if (segment.Category.Contains("睡眠")) bg = "#3498DB";
                        else if (segment.Category.Contains("用餐")) bg = "#2ECC71";
                        else if (segment.Category.Contains("清醒")) bg = "#F1C40F";

                        var left = $"{GetHourOffset(minTime, segment.Start) * 40}px";
                        var width = ToPx(segment.Start, segment.End);

                        <div class="gantt-segment" style="margin-left:@left; width:@width; background:@bg">
                            <div class="gantt-title">@segment.Label</div>
                            @if (!string.IsNullOrWhiteSpace(segment.TooltipText))
                            {
                                <div class="gantt-tooltip">@segment.TooltipText</div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>
